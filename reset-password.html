<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - WRKOUT</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#19e66b",
                        "background-light": "#f6f8f7",
                        "background-dark": "#112117",
                        "surface-dark": "#1a3224",
                        "border-dark": "#244732",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                },
            },
        }
    </script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-white antialiased min-h-screen flex flex-col relative overflow-hidden">

    <!-- Background Decorative Elements -->
    <div class="absolute inset-0 z-0 opacity-40 pointer-events-none">
        <div class="absolute -top-[20%] -right-[10%] w-[600px] h-[600px] rounded-full bg-primary/20 blur-[120px]"></div>
        <div class="absolute top-[40%] -left-[10%] w-[500px] h-[500px] rounded-full bg-primary/10 blur-[100px]"></div>
    </div>

    <!-- Main Content -->
    <div class="relative z-10 flex flex-col grow items-center justify-center p-4">

        <div
            class="w-full max-w-[480px] bg-[#1a2c22]/80 backdrop-blur-xl border border-border-dark shadow-2xl rounded-2xl p-8 transform transition-all">

            <div class="mb-6 text-center">
                <div
                    class="mx-auto size-12 text-primary flex items-center justify-center mb-4 bg-surface-dark rounded-full border border-border-dark">
                    <span class="material-symbols-outlined text-2xl">lock_reset</span>
                </div>
                <h1 class="text-2xl font-bold text-white mb-2">Set New Password</h1>
                <p class="text-gray-400 text-sm">Create a strong password to secure your account.</p>
            </div>

            <form id="reset-form" class="space-y-6">
                <div class="space-y-2">
                    <label for="password"
                        class="block text-xs font-semibold uppercase tracking-wider text-gray-400 pl-1">New
                        Password</label>
                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                            <span
                                class="material-symbols-outlined text-gray-500 group-focus-within:text-primary transition-colors">lock</span>
                        </div>
                        <input type="password" name="password" id="password" required
                            class="block w-full pl-11 pr-12 py-3.5 bg-surface-dark border border-border-dark rounded-xl text-white placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all sm:text-sm"
                            placeholder="••••••••">
                        <button type="button" id="toggle-password"
                            class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-500 hover:text-white transition-colors">
                            <span class="material-symbols-outlined text-xl">visibility</span>
                        </button>
                    </div>

                    <!-- Password Strength Checklist -->
                    <div class="bg-surface-dark/50 rounded-xl p-4 border border-border-dark mt-3 space-y-2">
                        <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Security
                            Requirements</p>
                        <ul class="text-xs space-y-1 text-gray-500 transition-colors">
                            <li id="rule-length" class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-[14px]">circle</span>
                                <span>At least 8 characters</span>
                            </li>
                            <li id="rule-uppercase" class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-[14px]">circle</span>
                                <span>One uppercase letter</span>
                            </li>
                            <li id="rule-number" class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-[14px]">circle</span>
                                <span>One number</span>
                            </li>
                            <li id="rule-special" class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-[14px]">circle</span>
                                <span>One special character (!@#$%^&*)</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <button type="submit" id="submit-btn" disabled
                    class="w-full flex items-center justify-center gap-2 bg-primary hover:bg-[#15c55a] text-black font-bold text-base py-3.5 rounded-xl shadow-[0_0_20px_rgba(25,230,107,0.3)] hover:shadow-[0_0_30px_rgba(25,230,107,0.5)] transition-all transform hover:-translate-y-0.5 active:translate-y-0 disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none disabled:transform-none disabled:bg-gray-600 disabled:text-gray-400">
                    Update Password
                    <span class="material-symbols-outlined text-xl">arrow_forward</span>
                </button>
            </form>

            <div id="message" class="mt-4 text-center text-sm hidden"></div>

            <div class="mt-6 text-center">
                <a href="login.html" class="text-sm text-gray-400 hover:text-white transition-colors">
                    Back to Login
                </a>
            </div>
        </div>
    </div>

    <!-- Load Supabase Config -->
    <script src="js/supabase.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById('reset-form');
            const passwordInput = document.getElementById('password');
            const togglePasswordBtn = document.getElementById('toggle-password');
            const submitBtn = document.getElementById('submit-btn');
            const messageEl = document.getElementById('message');

            const rules = {
                length: { regex: /.{8,}/, el: document.getElementById('rule-length') },
                uppercase: { regex: /[A-Z]/, el: document.getElementById('rule-uppercase') },
                number: { regex: /[0-9]/, el: document.getElementById('rule-number') },
                special: { regex: /[!@#$%^&*(),.?":{}|<>]/, el: document.getElementById('rule-special') }
            };

            // Toggle Password Visibility
            togglePasswordBtn.addEventListener('click', () => {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                togglePasswordBtn.querySelector('span').textContent = type === 'password' ? 'visibility' : 'visibility_off';
            });

            // Password Validation Logic
            passwordInput.addEventListener('input', () => {
                const val = passwordInput.value;
                let allValid = true;

                for (const key in rules) {
                    const rule = rules[key];
                    const isValid = rule.regex.test(val);
                    const icon = rule.el.querySelector('span');

                    if (isValid) {
                        rule.el.classList.remove('text-gray-500');
                        rule.el.classList.add('text-primary');
                        icon.textContent = 'check_circle';
                        icon.classList.add('text-primary');
                    } else {
                        rule.el.classList.add('text-gray-500');
                        rule.el.classList.remove('text-primary');
                        icon.textContent = 'circle';
                        icon.classList.remove('text-primary');
                        allValid = false;
                    }
                }

                submitBtn.disabled = !allValid;
            });

            // Handle Password Update
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Double check validation
                if (submitBtn.disabled) return;

                const password = passwordInput.value;

                // Ensure Supabase is loaded
                if (!window.supabaseClient || !window.supabaseClient.auth) {
                    // Try to reload or check if script loaded
                    // If still missing, define a fallback or show error
                    if (typeof supabase === 'undefined') {
                        showMessage('System Error: Database connection failed. Please reload the page.', 'text-red-400');
                        return;
                    }
                    // Re-init if needed (should be handled by supabase.js but acts as failsafe)
                    // window.supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY); 
                }

                setLoading(true);

                try {
                    // Check for active session first (sometimes needed for update)
                    /* 
                    const session = await window.supabaseClient.auth.getSession();
                    if (!session.data.session) {
                         // If no session, we might be relying on the recovery link's hash being processed automatically by Supabase client
                         // The Supabase JS client automatically detects the #access_token in URL and sets the session
                    } 
                    */

                    const { data, error } = await window.supabaseClient.auth.updateUser({
                        password: password
                    });

                    if (error) throw error;

                    showMessage('Password updated successfully! Redirecting...', 'text-primary');
                    form.reset();
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);

                } catch (error) {
                    console.error('Error updating password:', error);
                    showMessage(error.message, 'text-red-400');
                } finally {
                    setLoading(false);
                }
            });

            function showMessage(text, colorClass) {
                messageEl.textContent = text;
                messageEl.className = `mt-4 text-center text-sm ${colorClass}`;
                messageEl.classList.remove('hidden');
            }

            function setLoading(isLoading) {
                submitBtn.disabled = isLoading;
                const originalText = 'Update Password <span class="material-symbols-outlined text-xl">arrow_forward</span>';
                submitBtn.innerHTML = isLoading ?
                    '<span class="animate-spin material-symbols-outlined">progress_activity</span> Updating...' : originalText;
            }

            // Check for hash fragment errors
            const hash = window.location.hash;
            if (hash && hash.includes('error_description')) {
                const params = new URLSearchParams(hash.substring(1));
                const errorDescription = params.get('error_description');
                if (errorDescription) {
                    showMessage(errorDescription.replace(/\+/g, ' '), 'text-red-400');
                }
            }
        });
    </script>
</body>

</html>